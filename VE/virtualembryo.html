<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>Virtual Embryo!</title>
		<style>
			body {
				font-family: Monospace;
				background-color: #f0f0f0;
				margin: 0px;
				overflow:scroll;
			}
			.info {
				position: absolute;
				background-color: black;
				opacity: 0.8;
				color: white;
				text-align: center;
				top: 0px;
				width: 100%;
			}
			.info a {
				color: #00ffff;
			}
			/* The Modal (background) */
.modal {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1; /* Sit on top */
    padding-top: 100px; /* Location of the box */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
}

/* The Close Button */
.close {
    color: #aaaaaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}
		</style>
   <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.16/css/jquery.dataTables.min.css">

	</head>
	<body>
		<div class='intro'><h1>Virtual Embryo!</h1></div>
		<div id="container"></div>
		<div id="myModal" class="modal">

	  <!-- Modal content -->
	  <div class="modal-content">
	    <span class="close">&times;</span>
	    <p id='modalExpression'>Some text in the Modal..</p>
	    <div id='ISHPatterns'></div>
	  </div>

		</div>
		<div>
			<h2>Click a territory!</h2>
			<h3 id='territory_click'><h3>
		</div>
		<div><table id='dataTable' style='display:none'>
			<thead>
			<tr>
				<th>Plot</th>
				<th>Gene</th>
				<th>Nemve1 ID</th>
				<th>ISH</th>
				<th>NvERTx.id</th>
			</tr>
			</thead>
			<tbody  id='dataFill'>
			</tbody>
		</table></div>

  <script src="js/three.min.js"></script>
  <script src="js/TrackBallControls.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="js/jquery-csv.js"></script>
  <script src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
  <script>
  	
	var container, stats;
	var camera, controls, scene, renderer;
	var spheres = [];
	var mouse ;
	var raycaster ;
	var intersects;

	init();
	animate();

	function init() {
		container = document.getElementById( "container" );
		
		//set camera
		camera = new THREE.PerspectiveCamera( 75, (window.innerWidth*.75)/(window.innerHeight*.75), 0.1, 1000 );
		camera.position.z = -50;
		
		//set scene
		scene = new THREE.Scene();
		scene.background = new THREE.Color( 0xffffff );	
		scene.add( new THREE.AmbientLight( 0x555555 ) );
		
		// create a point light   
    	var pointLight =
      		new THREE.PointLight(0xFFFFFF);
   		// set its position
   		pointLight.position.x = 100;
   		pointLight.position.y = 10;
	    pointLight.position.z = -80;
    	// add to the scene
		scene.add(pointLight);
    
    	//do this for three lights
   		var pointLight2 = 
    		new THREE.PointLight(0xFFFFFF);
    	pointLight2.position.x = -100;
  	 	pointLight2.position.y = 10;
    	pointLight2.position.z = -80;
    	scene.add(pointLight2);
    
    	var pointLight3 = 
    		new THREE.PointLight(0xFFFFFF);
    	pointLight3.position.x = 0;
    	pointLight3.position.y = 10;
    	pointLight3.position.z = 80;
   	 	scene.add(pointLight3);
   	 	
   	 	// Set up the spheres vars
    	var RADIUS = 5;
    	var SEGMENTS = 16;
    	var RINGS = 16;
    	
    	// loop through and draw 1000 spheres around the points of a big sphere
    	for(var i = 0; i < 1000; i++){
    
			// initial location and radius of sphere
			var x0 = 0
			var y0 = 0
			var z0 = 0
			var radius = 10
		
			// draw the sphere of spheres
			var u = Math.random();
	   		var v = Math.random();
   			var theta = 2 * Math.PI * u;
	   		var phi = Math.acos(2 * v - 1);
   			var x = x0 + (radius * Math.sin(phi) * Math.cos(theta));
   			var y = y0 + (radius * Math.sin(phi) * Math.sin(theta));
   			var z = z0 + (radius * Math.cos(phi));

   			var sphereMaterial;
   		
   			// logical getting the colors for the territories
   			if (y > -10 && y < -9 ){
   				sphereMaterial =	
   				new THREE.MeshLambertMaterial(
        		{
          			color: 0xff9900
       			});	    
			} else if (y > 1 && y < 5 ){
   				sphereMaterial =	
   				new THREE.MeshLambertMaterial(
  	    	  	{
          			color: 0xcc33ff
       			});
          	} else if (y >= 5 && y < 8 ) {
   			sphereMaterial =	
   			new THREE.MeshLambertMaterial(
        	{
          		color: 0x3399ff
       		});
       		} else if ( y >=8 ){
       		sphereMaterial =	
   			new THREE.MeshLambertMaterial(
        	{
          		color: 0x33cc33
       		});
          	} else {
          	sphereMaterial =	
   			new THREE.MeshLambertMaterial(
        	{
          		color: 0xb3b5b7
       		});
          	}
		
			// draw the individual sphere
			var sphere = new THREE.Mesh(
		    	new THREE.SphereGeometry(RADIUS,SEGMENTS,RINGS),
	    		sphereMaterial);
	    	
	    	   		
   			// set the positions
   			sphere.position.y = y
   			sphere.position.x = x
   			sphere.position.z = z

			// add the sphere to the scene.
	    	scene.add(sphere);
	    	// add to sphere array
	    	spheres.push( sphere );
	    	
		}
		
		renderer = new THREE.WebGLRenderer();
		renderer.setSize( window.innerWidth*.75, window.innerHeight*.75 );
		container.appendChild( renderer.domElement );
		
				//set controls
		controls = new THREE.TrackballControls( camera, container);
		controls.rotateSpeed = 1.0;
		controls.zoomSpeed = 1.2;
		controls.panSpeed = 0.8;
		controls.noZoom = false;
		controls.noPan = false;
		controls.staticMoving = true;
		controls.dynamicDampingFactor = 0.3;
		
		
		// set up ray to pick cells
		raycaster = new THREE.Raycaster();
		mouse = new THREE.Vector2();
		
		//add listeners
		container.addEventListener( 'mousedown', onDocumentMouseDown, false );
		container.addEventListener( 'touchstart', onDocumentTouchStart, false );
		window.addEventListener( 'resize', onWindowResize, false );
	}
	
	function onDocumentTouchStart( event ) {
		event.preventDefault();
		event.clientX = event.touches[0].clientX;
		event.clientY = event.touches[0].clientY;
		onDocumentMouseDown( event );
	}
	
	var territory;
	function onDocumentMouseDown( event ) {
		event.preventDefault();
		var rect = renderer.domElement.getBoundingClientRect();
		mouse.x = ( ( event.clientX - rect.left ) / ( rect.width - rect.left ) ) * 2 - 1;
		mouse.y = - ( ( event.clientY - rect.top ) / ( rect.bottom - rect.top) ) * 2 + 1;
		raycaster.setFromCamera( mouse, camera );
		var intersects = raycaster.intersectObjects( spheres );
		if ( intersects.length > 0 ) {
			var cellColor = intersects[ 0 ].object.material.color.getHex()
			intersects[ 0 ].object.material.color.setHex( Math.random() * 0xffffff );
			if (cellColor === 0xb3b5b7){
				document.getElementById("territory_click").innerHTML = "You clicked the endoderm<br>These genes are expressed there:";
				clickedTerritory = 'ectoderm';
				generateTable(clickedTerritory);
			} else if (cellColor === 0xcc33ff){
				document.getElementById("territory_click").innerHTML = "You clicked the external ring<br>These genes are expressed there:";
				clickedTerritory = 'external_ring';
				generateTable(clickedTerritory); 
			} else if (cellColor === 0x3399ff){
				document.getElementById("territory_click").innerHTML = "You clicked the central ring<br>These genes are expressed there:";
				clickedTerritory = 'central_ring'; 
				generateTable(clickedTerritory);
			} else if (cellColor === 0x33cc33){
				document.getElementById("territory_click").innerHTML = "You clicked the the central domain<br>These genes are expressed there:";
				clickedTerritory = 'central_domain';
				generateTable(clickedTerritory);
			} else if (cellColor === 0xff9900){
				document.getElementById("territory_click").innerHTML = "You clicked the apical domain<br>These genes are expressed there:";
				clickedTerritory = 'apical_domain'; 
				generateTable(clickedTerritory);
			}
			
		}
	} 
	function generateTable(territory) {
      var html = '';
      var filterArr = annotationsArr.filter(function(x) {
    	return x[2] === territory;
		});

        for(var row in filterArr) {
          html += '<tr>\r\n';
          html += '<td><button  onclick="getExpression(this)" value="'+filterArr[row][0]+'">Show Expression!</button>'
          for(var item in filterArr[row]) {
            html += '<td>' + filterArr[row][item] + '</td>\r\n';
          }
          html += '</tr>\r\n';
        }
      
      document.getElementById("dataFill").innerHTML = html;
      $('#dataTable').DataTable();
      document.getElementById("dataTable").style.display = 'block';
    }
	function onWindowResize() {
		camera.aspect = window.innerWidth*.75 / window.innerHeight*.75;
		camera.updateProjectionMatrix();
		renderer.setSize( window.innerWidth*.75, window.innerHeight*.75 );
	}
	
	function animate() {
		requestAnimationFrame( animate );
		render();
	};
	
	function render() {
		renderer.render(scene, camera);
		controls.update(); 
	}

var allText;
function readTextFile(file)
{
    var rawFile = new XMLHttpRequest();
    rawFile.open("GET", file, false);
    rawFile.onreadystatechange = function ()
    {
        if(rawFile.readyState === 4)
        {
            if(rawFile.status === 200 || rawFile.status == 0)
            {
              allText = rawFile.responseText;
            }
        }
    }
    rawFile.send(null);
    return allText
};

// Get the modal
var modal = document.getElementById('myModal');

// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

var ISHhtml;
function getExpression(gene){

	document.getElementById("modalExpression").innerHTML = gene.value;
	var imageLinksArrGene = imageLinksArr.filter(function(x) {
    	return x[0] === gene;
		});
	for (var row in imageLinksArrGene){
		ISHhtml += '<h3>Expression for'+imageLinksArrGene[row][0]+'</h3></br>';
		ISHhtml += '<img src = "images/'+imageLinksArrGene[row][1]+'">'+imageLinksArrGene[row][0]+'</img></br>';
	}
	document.getElementById("ISHPatterns").innerHTML = imageLinksArrGene;
	modal.style.display = "block";
}
// When the user clicks on <span> (x), close the modal
span.onclick = function() {
    modal.style.display = "none";
}

// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
}

var annotations;
annotations = readTextFile('https://raw.githubusercontent.com/ScientistJake/ScientistJake.github.io/master/VE/tables/annot.csv');
var annotationsArr = $.csv.toArrays(annotations); 

var imageLinks;
imageLinks = readTextFile('https://raw.githubusercontent.com/ScientistJake/ScientistJake.github.io/master/VE/tables/images.csv');
var imageLinksArr = $.csv.toArrays(imageLinks);
console.log(imageLinksArr) 


$(document).ready(function () {



//var html = generateTable(territory);

    // build HTML table data from an array (one or two dimensional)

    

//$('#dataTable').DataTable();


});
  </script>
  <script type="text/javascript">

</script>
</body>
</html>
